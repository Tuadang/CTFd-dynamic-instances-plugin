{% extends "challenge.html" %}

{% block description %}
<div class="challenge-desc mb-4">
  {{ challenge.description | safe }}
</div>
{% endblock %}

{% block input %}
<div class="challenge-view">
  <input type="hidden" id="challenge-id" class="challenge-id" value="{{ challenge.id }}">

  <div class="row">
    <!-- Instance Control -->
    <div class="col-md-7 mb-3">
      <div class="card bg-light border-secondary shadow-sm">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
          <strong><i class="fas fa-server me-2"></i>Instance Control</strong>
          <div id="instance-status-badge">
            <span class="badge bg-danger">Offline</span>
          </div>
        </div>

        <div class="card-body">
          <div class="d-flex gap-2 mb-4">
            <button id="start-instance" class="btn btn-success flex-grow-1" aria-label="Start instance">
              <i class="fas fa-play me-1"></i> Start
            </button>

            <button id="status-instance" class="btn btn-outline-info" aria-label="Refresh instance status">
              <i class="fas fa-sync-alt"></i>
            </button>

            <button id="stop-instance" class="btn btn-outline-danger" aria-label="Stop instance">
              <i class="fas fa-stop me-1"></i> Stop
            </button>
          </div>

          <label class="form-label small text-muted text-uppercase fw-bold mb-2">Connection Info</label>
          <div class="input-group">
            <input 
              type="text" 
              id="instance-connection" 
              class="form-control font-monospace" 
              value="Instance not started..." 
              readonly
            >
            <button class="btn btn-outline-secondary" type="button" onclick="copyConnection()" aria-label="Copy connection info">
              <i class="fas fa-copy"></i>
            </button>
          </div>

          <div id="instance-timer" class="mt-2 small text-muted d-none"></div>
        </div>
      </div>
    </div>

    <!-- Submit Flag -->
    <div class="col-md-5">
      <div class="card border-primary shadow-sm h-100">
        <div class="card-header bg-primary text-white">
          <strong>Submit Flag</strong>
        </div>

        <div class="card-body d-flex flex-column justify-content-center">
          <form id="flag-submit-form">
            <div class="form-group mb-3">
              <input 
                type="text" 
                id="challenge-input" 
                class="challenge-input form-control form-control-lg" 
                name="submission" 
                placeholder="CTF{flag_here}"
                required
              >
            </div>

            <button id="challenge-submit" class="btn btn-primary btn-lg w-100" type="submit">
              Submit
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Simple helper to copy the connection string
  function copyConnection() {
    var copyText = document.getElementById("instance-connection");
    if (copyText.value && !copyText.value.includes("not started")) {
        copyText.select();
        copyText.setSelectionRange(0, 99999);
        navigator.clipboard.writeText(copyText.value);
        alert("Connection string copied!");
    }
  }
</script>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/k8s_view.js') }}"></script>
{% endblock %}
